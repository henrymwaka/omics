{% extends "base.html" %}
{% block content %}
<div class="container mx-auto px-4 py-6">
  <h2 class="text-xl font-bold mb-3">Job #{{ job.id }} — {{ job.job_type }}</h2>
  <div class="text-sm text-gray-400 mb-3 flex items-center gap-4">
    <span>Status: <span id="job-status">{{ job.status }}</span></span>
    <span>Started: {{ job.started_at }}</span>
    <span>Finished: {{ job.finished_at|default:"—" }}</span>
    <button id="scroll-toggle"
            class="ml-auto bg-gray-700 hover:bg-gray-600 text-white text-xs px-2 py-1 rounded">
      ⏸ Pause Auto-Scroll
    </button>
  </div>

  <div id="job-log"
       class="mt-2 p-3 bg-[#0d1117] text-[#e5e5e5] font-mono rounded-md overflow-y-auto border border-gray-700"
       style="max-height:70vh;">
    <div class="text-gray-500">Loading logs...</div>
  </div>
</div>

<script>
const jobId = {{ job.id }};
let lastLineCount = 0;
let autoScroll = true;
const toggleBtn = document.getElementById("scroll-toggle");

toggleBtn.addEventListener("click", () => {
  autoScroll = !autoScroll;
  toggleBtn.textContent = autoScroll ? "⏸ Pause Auto-Scroll" : "▶ Resume Auto-Scroll";
  toggleBtn.classList.toggle("bg-gray-700", autoScroll);
  toggleBtn.classList.toggle("bg-green-700", !autoScroll);
});

function classifyLine(line) {
  const txt = line.toLowerCase();
  if (txt.includes("error") || txt.includes("fail") || txt.includes("exception")) return "text-red-400";
  if (txt.includes("% complete") || txt.includes("running") || txt.includes("processing")) return "text-yellow-400";
  if (txt.includes("complete") || txt.includes("success") || txt.includes("finished")) return "text-green-400";
  return "text-gray-300";
}

async function fetchLog() {
  try {
    const res = await fetch(`/api/jobs/${jobId}/stream/?lines=150`);
    if (!res.ok) return;
    const data = await res.json();
    const container = document.getElementById("job-log");
    const statusSpan = document.getElementById("job-status");
    if (!container) return;

    statusSpan.textContent = data.status;
    const newText = data.log_tail || "";
    const lines = newText.split("\n");

    if (lines.length > lastLineCount) {
      const newLines = lines.slice(lastLineCount);
      newLines.forEach(line => {
        if (!line.trim()) return;
        const div = document.createElement("div");
        div.textContent = line;
        div.classList.add("log-line", classifyLine(line));
        container.appendChild(div);
      });
      lastLineCount = lines.length;
      if (autoScroll && container.scrollHeight - container.scrollTop - container.clientHeight < 60)
        container.scrollTop = container.scrollHeight;
    }
  } catch (e) {
    console.error("Log fetch error:", e);
  }
}

setInterval(fetchLog, 5000);
fetchLog();
</script>
{% endblock %}
